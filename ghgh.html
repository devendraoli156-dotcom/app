import sys
import os
import json
from datetime import datetime
from PyQt5.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, 
                             QHBoxLayout, QListWidget, QTextEdit, QPushButton, 
                             QInputDialog, QMessageBox, QFileDialog, QSplitter)
from PyQt5.QtCore import Qt
from PyQt5.QtGui import QFont, QIcon

class NotesApp(QMainWindow):
    def __init__(self):
        super().__init__()
        self.notes = {}
        self.current_note = None
        self.initUI()
        self.load_notes()
        
    def initUI(self):
        self.setWindowTitle('Quick Notes App')
        self.setGeometry(100, 100, 800, 500)
        
        # Central widget and main layout
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        main_layout = QHBoxLayout(central_widget)
        
        # Splitter for resizable panels
        splitter = QSplitter(Qt.Horizontal)
        
        # Left panel for notes list
        left_widget = QWidget()
        left_layout = QVBoxLayout(left_widget)
        
        self.notes_list = QListWidget()
        self.notes_list.itemClicked.connect(self.select_note)
        left_layout.addWidget(self.notes_list)
        
        # Buttons for note management
        button_layout = QHBoxLayout()
        self.new_btn = QPushButton('New Note')
        self.new_btn.clicked.connect(self.new_note)
        self.delete_btn = QPushButton('Delete Note')
        self.delete_btn.clicked.connect(self.delete_note)
        
        button_layout.addWidget(self.new_btn)
        button_layout.addWidget(self.delete_btn)
        left_layout.addLayout(button_layout)
        
        # Right panel for note content
        right_widget = QWidget()
        right_layout = QVBoxLayout(right_widget)
        
        self.note_title = QTextEdit()
        self.note_title.setMaximumHeight(40)
        self.note_title.setPlaceholderText("Note Title")
        self.note_title.textChanged.connect(self.save_note)
        
        self.note_content = QTextEdit()
        self.note_content.setPlaceholderText("Write your note here...")
        self.note_content.textChanged.connect(self.save_note)
        
        right_layout.addWidget(self.note_title)
        right_layout.addWidget(self.note_content)
        
        # Add widgets to splitter
        splitter.addWidget(left_widget)
        splitter.addWidget(right_widget)
        splitter.setSizes([200, 600])
        
        main_layout.addWidget(splitter)
        
        # Set font
        font = QFont("Arial", 10)
        self.note_content.setFont(font)
        
        # Set style
        self.setStyleSheet("""
            QMainWindow {
                background-color: #f5f5f5;
            }
            QTextEdit {
                background-color: white;
                border: 1px solid #ccc;
                border-radius: 4px;
                padding: 8px;
            }
            QListWidget {
                background-color: white;
                border: 1px solid #ccc;
                border-radius: 4px;
                padding: 8px;
            }
            QPushButton {
                background-color: #4CAF50;
                color: white;
                border: none;
                padding: 8px;
                border-radius: 4px;
            }
            QPushButton:hover {
                background-color: #45a049;
            }
        """)
        
    def new_note(self):
        title, ok = QInputDialog.getText(self, 'New Note', 'Note title:')
        if ok and title:
            timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            self.notes[timestamp] = {
                'title': title,
                'content': '',
                'created': timestamp,
                'updated': timestamp
            }
            self.update_notes_list()
            self.notes_list.setCurrentRow(len(self.notes) - 1)
            self.select_note_by_timestamp(timestamp)
    
    def select_note(self, item):
        self.current_note = item.data(Qt.UserRole)
        self.display_note()
    
    def select_note_by_timestamp(self, timestamp):
        for i in range(self.notes_list.count()):
            item = self.notes_list.item(i)
            if item.data(Qt.UserRole) == timestamp:
                self.notes_list.setCurrentItem(item)
                self.current_note = timestamp
                self.display_note()
                break
    
    def display_note(self):
        if self.current_note and self.current_note in self.notes:
            note = self.notes[self.current_note]
            self.note_title.blockSignals(True)
            self.note_content.blockSignals(True)
            
            self.note_title.setPlainText(note['title'])
            self.note_content.setPlainText(note['content'])
            
            self.note_title.blockSignals(False)
            self.note_content.blockSignals(False)
    
    def save_note(self):
        if self.current_note and self.current_note in self.notes:
            self.notes[self.current_note]['title'] = self.note_title.toPlainText()
            self.notes[self.current_note]['content'] = self.note_content.toPlainText()
            self.notes[self.current_note]['updated'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            
            self.update_notes_list()
            self.save_notes_to_file()
    
    def delete_note(self):
        if self.current_note:
            reply = QMessageBox.question(self, 'Delete Note', 
                                        "Are you sure you want to delete this note?",
                                        QMessageBox.Yes | QMessageBox.No)
            if reply == QMessageBox.Yes:
                del self.notes[self.current_note]
                self.current_note = None
                self.note_title.clear()
                self.note_content.clear()
                self.update_notes_list()
                self.save_notes_to_file()
    
    def update_notes_list(self):
        self.notes_list.clear()
        sorted_notes = sorted(self.notes.items(), key=lambda x: x[1]['updated'], reverse=True)
        
        for timestamp, note in sorted_notes:
            item_text = f"{note['title']}\nUpdated: {note['updated']}"
            item = QListWidgetItem(item_text)
            item.setData(Qt.UserRole, timestamp)
            self.notes_list.addItem(item)
    
    def save_notes_to_file(self):
        with open('notes.json', 'w') as f:
            json.dump(self.notes, f)
    
    def load_notes(self):
        if os.path.exists('notes.json'):
            try:
                with open('notes.json', 'r') as f:
                    self.notes = json.load(f)
                self.update_notes_list()
            except:
                self.notes = {}
        else:
            self.notes = {}

if __name__ == '__main__':
    app = QApplication(sys.argv)
    window = NotesApp()
    window.show()
    sys.exit(app.exec_())
